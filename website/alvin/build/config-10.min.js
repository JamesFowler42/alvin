function mConst(){return{chartBottom:-50,chartTop:4000,awakeAbove:1000,lightAbove:120,sampleIntervalMins:10,swpAppStoreUrl:"https://itunes.apple.com/app/smartwatch-pro-for-pebble/id673907094?mt=8&at=10lIFm&pt=409665&ct=alvin_web",displayDateFmt:"WWW, NNN dd, yyyy hh:mm",iosDateFormat:"dd N yyyy hh:mm",swpUrlDate:"yyyy-MM-ddThh:mm:00",emailHeader:"<h2>CSV Sleep data</h2>",emailHeader2:"<h2>Chart Display</h2>",emailFooter1:"<br/>Note: -1 is no data captured, -2 is ignore set, ALARM, START and END nodes represent smart alarm actual, start and end",emailFooter2:"<br/><br/><small>Please don't reply, this is an unmonitored mailbox</small><br/>",emailAddressMandatory:"valid email address is required",sendingEmail:"Sending...",url:"http://ui.alvin.net/keith.j.fowler/alvin/view-",report:"Report"}}function buildGraphDataSet(e,f,c){var d=new Date(e);for(var b=0;b<f.length;b++){if(f[b]===""){continue}var a=new Array();a[0]=d;a[1]=parseInt(f[b],10);if(a[1]<0){a[1]=null}c[b]=a;d=d.addMinutes(mConst().sampleIntervalMins)}}function populateIgnore(f,c,h,a){var e=a/h.length;var d=new Date(f);for(var b=0;b<h.length;b++){if(h[b]===""){continue}if(parseInt(h[b],10)==-2){var g={verticalLine:{name:"ignore",x:d,lineWidth:e,yOffset:0,color:"#184E99",shadow:false}};c.show=true;c.objects.push(g)}d=d.addMinutes(mConst().sampleIntervalMins)}}function returnAbsoluteMatch(e,b,c){var a=e;while(a.getTime()<b.getTime()){var d=a.format("hhmm");if(c===d){return a}a=a.addMinutes(1)}return e}function startStopAlarm(h,k,r,l,p,g,j,f){if(h){var q=fixLen(k)+fixLen(r);var o=fixLen(l)+fixLen(p);var s=new Date(g);var a=null;var c=null;for(var n=0;n<f.length;n++){var e=s.format("hhmm");var m=s;s=s.addMinutes(mConst().sampleIntervalMins);var d=s.format("hhmm");if(a===null&&q>=e&&q<=d){a=returnAbsoluteMatch(m,s,q)}if(c===null&&o>=e&&o<=d){c=returnAbsoluteMatch(m,s,o)}if(c!==null&&a!==null){break}}if(a!==null){var t={dashedVerticalLine:{name:"start",x:a,lineWidth:1,yOffset:0,dashPattern:[1,4],color:"rgb(76, 217, 100)",shadow:false}};j.show=true;j.objects.push(t)}if(c!==null){var b={dashedVerticalLine:{name:"end",x:c,lineWidth:1,yOffset:0,dashPattern:[1,4],color:"rgb(255, 59, 48)",shadow:false}};j.show=true;j.objects.push(b)}}}function calculateStats(g,f,m,s){var o=new Date(g);var t=true;var b=null;var w=null;var a=null;var l=null;var u=null;var p=null;for(var y=0;y<f.length;y++){if(f[y]===""){continue}var A=parseInt(f[y],10);var d=o.format("hhmm");var r=o;o=o.addMinutes(mConst().sampleIntervalMins);var c=o.format("hhmm");if(m!="N"&&m>=d&&m<=c){a=returnAbsoluteMatch(r,o,m);l=y;break}else{if(A!=-1&&A!=-2&&A<=mConst().awakeAbove){if(t){b=r;w=y;var k={verticalLine:{name:"begin",x:b,lineWidth:1,yOffset:0,color:"rgb(255, 149, 0)",shadow:false}};s.show=true;s.objects.push(k);t=false}u=o;p=y}}}if(a===null&&u!==null){a=u;l=p}var q=0;var x=0;var e=0;var z=0;if(w!==null&&l!==null){for(var v=w;v<=l;v++){if(f[v]===""){continue}var h=parseInt(f[v],10);if(h==-1||h==-2){z++}else{if(h>mConst().awakeAbove){q++}else{if(h>mConst().lightAbove){e++}else{x++}}}}}if(a!==null){var n={verticalLine:{name:"endstop",x:a,lineWidth:1,yOffset:0,color:"rgb(255, 149, 0)",shadow:false}};s.show=true;s.objects.push(n)}return{tbegin:b,tends:a,deep:x,light:e,awake:q,ignore:z}}function generateCopyLinkData(a,k,j,m,g,l,d,c){var b=new Date(a);var f="<pre>";for(var e=0;e<k.length;e++){if(k[e]===""){continue}f=f+b.format("hh:mm")+","+k[e]+"<br/>";b=b.addMinutes(mConst().sampleIntervalMins)}if(j){f=f+m+":"+g+",START<br/>"+l+":"+d+",END<br/>";if(c!="N"){var h=c.substr(0,2)+":"+c.substr(2,2);f=f+h+",ALARM<br/>"}}return{body:f+"</pre>"}}$("document").ready(function(){adjustForViewport();document.ios=navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i);if(document.ios){$(".android").hide()}else{$(".ios").hide()}var w=getParameterByName("base");var l=new Date().valueOf();if(w!==""&&w!=="null"){l=parseInt(w,10)}var B=getParameterByName("graph");var e=getParameterByName("fromhr");var k=getParameterByName("frommin");var y=getParameterByName("tohr");var D=getParameterByName("tomin");var x=getParameterByName("smart");var i=getParameterByName("vers");var A=getParameterByName("goneoff");var s=decodeURIComponent(getParameterByName("emailto"));var G=decodeURIComponent(getParameterByName("potoken"));var J=decodeURIComponent(getParameterByName("pouser"));var h=decodeURIComponent(getParameterByName("postat"));var v=decodeURIComponent(getParameterByName("swpdo"));var q=decodeURIComponent(getParameterByName("lifxtoken"));var d=decodeURIComponent(getParameterByName("lifxtime"));var I=decodeURIComponent(getParameterByName("swpstat"));var H=getParameterByName("noset");var g=getParameterByName("token");var j=decodeURIComponent(getParameterByName("exptime"));var f=getParameterByName("usage");var a=getParameterByName("lazarus");var o=getParameterByName("hueip");var n=getParameterByName("hueuser");var t=getParameterByName("hueid");var r=decodeURIComponent(getParameterByName("ifkey"));var c=decodeURIComponent(getParameterByName("ifstat"));var p=x==="Y";var b=H==="Y";if(b){$(".noset").hide()}$("#emailto").val(s);$("#ptoken").val(G);$("#puser").val(J);$("#lifxToken").val(q);$("#lifxTime").val(d);$("#swpdo").prop("checked",v==="Y");$("#presult").text(h);$("#swpstat").text(I);$("#exptime").text(j);$("#usage").prop("checked",f!=="N");$("#hueip").val(o);$("#hueuser").val(n);$("#hueid").val(t);$("#lazarus").prop("checked",a!=="N");$("#ifkey").val(r);$("#ifstat").text(c);if(h==="OK"){$("#lipushover").addClass("green");$("#presult").addClass("green")}else{if(h===""||h===null||h==="Disabled"){$("#lipushover").addClass("blue");$("#presult").addClass("blue")}else{$("#lipushover").addClass("red");$("#presult").addClass("red")}}if(I==="OK"){$("#liswp").addClass("green");$("#swpstat").addClass("green")}else{if(I===""||I===null||I==="Disabled"){$("#liswp").addClass("blue");$("#swpstat").addClass("blue")}else{$("#liswp").addClass("red");$("#swpstat").addClass("red")}}if(q===""){$("#lilifx").addClass("blue")}else{$("#lilifx").addClass("green")}if(o===""){$("#lihue").addClass("blue")}else{$("#lihue").addClass("green")}if(f!=="N"){$("#liusage").addClass("green")}else{$("#liusage").addClass("blue")}if(a!=="N"){$("#lilazarus").addClass("green")}else{$("#lilazarus").addClass("blue")}if(c==="OK"){$("#liif").addClass("green");$("#ifstat").addClass("green")}else{if(c===""||c===null||c==="Disabled"){$("#liif").addClass("blue");$("#ifstat").addClass("blue")}else{$("#liif").addClass("red");$("#ifstat").addClass("red")}}$("li.red").removeClass("liclosed").addClass("liopen");$("#version").text(parseInt(i,10)/10);$("#sleep-time").text(new Date(l).format(mConst().displayDateFmt));if((new Date().valueOf())%10===0){$("#info-message").css("display","block")}$(".licollapse > p").click(function(){if($(this).parent().hasClass("liopen")){$(this).parent().removeClass("liopen").addClass("liclosed")}else{$(this).parent().removeClass("liclosed").addClass("liopen")}});if(!b){setScreenMessageBasedOnVersion(i)}var F=B.split("!");var z=new Array();buildGraphDataSet(l,F,z);var m={show:false,objects:[]};populateIgnore(l,m,F,$("#chart1").width());startStopAlarm(p,e,k,y,D,l,m,F);var C=calculateStats(l,F,A,m);$("#ttotal").text(hrsmin((C.deep+C.light+C.awake+C.ignore)*mConst().sampleIntervalMins));$("#tawake").text(hrsmin(C.awake*mConst().sampleIntervalMins));$("#tlight").text(hrsmin(C.light*mConst().sampleIntervalMins));$("#tdeep").text(hrsmin(C.deep*mConst().sampleIntervalMins));$("#tignore").text(hrsmin(C.ignore*mConst().sampleIntervalMins));if(C.tbegin!==null&&C.tends!==null){$("#swpnodata").hide();$("#tstarts").text(C.tbegin.format(mConst().iosDateFormat));$("#tends").text(C.tends.format(mConst().iosDateFormat));var u="swpro2hk://?source=Alvin&starts="+C.tbegin.format(mConst().swpUrlDate)+"&ends="+C.tends.format(mConst().swpUrlDate);if(g!=null&&g!==""){u+="&at="+g}$("#swp").prop("href",u);if(!b){$("#swp").click(function(){setTimeout(function(){window.location.href="pebblejs://close"},250)})}}else{$("#swp").hide()}$("#swplink").prop("href",mConst().swpAppStoreUrl);$("#swplink").click(function(){setTimeout(function(){window.location.href="pebblejs://close"},250)});var E=[["Restless",C.awake],["Light",C.light],["Deep",C.deep],["Ignore",C.ignore]];$(document).ready(function(){document.plot1=$.jqplot("chart1",[z],{grid:{background:"#2066C7",gridLineColor:"#1E75D7",borderColor:"#1E75D7",shadow:false},animate:true,canvasOverlay:m,series:[{showMarker:false,breakOnNull:true,color:"#40ADEB",label:new Date(l).format("yyyy-MM-dd"),shadow:false}],axesDefaults:{labelRenderer:$.jqplot.CanvasAxisLabelRenderer,showTicks:false,showTickMarks:false},legend:{show:false,location:"ne"},axes:{xaxis:{renderer:$.jqplot.DateAxisRenderer,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{formatString:"%R",angle:-30,fontSize:"8pt",textColor:"#40ADEB"},tickInterval:"1 hour",pad:0,showTicks:true,showTickMarks:true,min:new Date(l)},yaxis:{ticks:[mConst().chartBottom,mConst().lightAbove,mConst().awakeAbove,mConst().chartTop],labelRenderer:$.jqplot.CanvasAxisLabelRenderer,label:"Movement",min:mConst().chartBottom,max:mConst().chartTop,labelOptions:{textColor:"#1898FF"}}}});document.plot2=jQuery.jqplot("chart2",[E],{grid:{background:"#FF7D48",borderColor:"#FF7D48",shadow:false},seriesColors:["#FFFF92","#FFA966","#FF3C31","rgb(130,130,130)"],seriesDefaults:{renderer:jQuery.jqplot.PieRenderer,rendererOptions:{showDataLabels:true,shadow:false}},legend:{show:true,location:"e"}})});$(".save").click(function(){var K={action:"save",emailto:safeTrim($("#emailto").val()),pouser:safeTrim($("#puser").val()),potoken:safeTrim($("#ptoken").val()),swpdo:$("#swpdo").is(":checked")?"Y":"N",usage:$("#usage").is(":checked")?"Y":"N",lifxtoken:safeTrim($("#lifxToken").val()),lifxtime:safeTrim($("#lifxTime").val()),hueip:safeTrim($("#hueip").val()),hueuser:safeTrim($("#hueuser").val()),hueid:safeTrim($("#hueid").val()),lazarus:$("#lazarus").is(":checked")?"Y":"N",testsettings:$("#testsettings").is(":checked")?"Y":"N",ifkey:safeTrim($("#ifkey").val())};document.location="pebblejs://close#"+encodeURIComponent(JSON.stringify(K))});$("#mail").removeAttr("disabled");$("#mail").click(function(){var K=$("#emailto").val();if(K===""||!validateEmail(K)){$("#emailSendResult").text(mConst().emailAddressMandatory);$("#emailSendResult").addClass("red");return}var N=generateCopyLinkData(l,F,p,e,k,y,D,A);var M="<a href='"+mConst().url+i+".html?base="+l+"&graph="+B+"&fromhr="+e+"&tohr="+y+"&frommin="+k+"&tomin="+D+"&smart="+x+"&vers="+i+"&goneoff="+A+"&emailto="+encodeURIComponent(K)+"&noset=Y'>"+mConst().report+"</a><br/>";var L={from:"Alvin <noreply@alvin.co.uk>",to:K,subject:"Alvin-"+new Date(l).format("yyyy-MM-dd"),message:mConst().emailHeader2+M+mConst().emailHeader+N.body+mConst().emailFooter1+mConst().emailFooter2};$("#mail").attr("disabled","disabled");$("#emailSendResult").removeClass("red").removeClass("green");$("#emailSendResult").text(mConst().sendingEmail);sendMailViaServer(L,function(O,P){if(O===1){$("#emailSendResult").addClass("green")}else{$("#emailSendResult").addClass("red")}$("#emailSendResult").text(P);$("#mail").removeAttr("disabled")})})});